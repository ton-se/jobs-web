import { ImageResponse } from 'next/og'
import { getJob } from '@/app/lib/data'

export const size = {
    width: 1200,
    height: 630,
}

export const contentType = 'image/png'

export default async function Image({ params }: { params: { slug: string } }) {
    const job = await getJob(params)
    if (!job) return null

    // Truncate helper function
    const truncate = (text: string, maxLength: number) => {
        return text.length > maxLength ? `${text.slice(0, maxLength - 3)}...` : text
    }

    const descriptionParts = [job.locations?.[0], job.types?.[0]].filter(Boolean)
    const rawDescription = descriptionParts.join(' | ')

    // Fetch and convert image to base64
    const phoneImageUrl = new URL('/phone.png', process.env.NEXT_PUBLIC_BASE_URL).toString()

    return new ImageResponse(
        <div
            style={{
                width: '1200px',
                height: '630px',
                backgroundColor: '#f5f5f5',
                display: 'flex',
                position: 'relative',
                alignItems: 'center',
                flexDirection: 'column',
                justifyContent: 'center',
                paddingTop: 120,
                paddingLeft: 60,
                paddingRight: 260,
                fontFamily: 'Inter, sans-serif',
                overflow: 'hidden'
            }}
        >
            <div style={{
                position: 'absolute',
                width: 500,
                height: 500,
                display: 'flex',
                backgroundColor: '#10b981',
                borderRadius: '50%',
                bottom: -300,
                left: -300
            }}></div>
            <div style={{
                position: 'absolute',
                width: '900px',
                height: '900px',
                display: 'flex',
                backgroundColor: '#10b981',
                borderRadius: '50%',
                top: '-130px',
                right: '-600px'
            }}></div>

            <div style={{ position: 'absolute', display: 'flex', height: '100%', width: 270, top: 24, right: 40}}>
                <img src={phoneImageUrl} alt="phone"/>
            </div>

            <div style={{
                position: 'absolute',
                left: 32,
                top: 24,
                display: 'flex',
                justifyContent: 'center',
                alignItems: 'center'
            }}>
                <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 60 60">
                    <circle cx="30" cy="30" fill="#00B76E" r="30" strokeWidth='0.832946'/>
                    <g transform="matrix(0.23686991,0,0,0.23686991,-9.0841273,-9.082943)" id="g1">
                        <path fill="#ffffff"
                              d="m 164.78,97.18 c -36.91,0 -66.83,30.04 -66.83,67.1 0,37.05 29.92,67.1 66.83,67.1 12.93,0 25,-3.7 35.22,-10.07 l 9.39,9.39 c 2.82,2.82 7.38,2.82 10.2,0 l 10.35,-10.35 c 2.82,-2.82 2.82,-7.39 0,-10.2 l -9.19,-9.19 c 6.87,-10.55 10.87,-23.14 10.87,-36.68 0,-37.06 -29.93,-67.1 -66.84,-67.1 z m 0,21.6 c 0.93,-0.01 1.86,0.04 2.81,0.14 11.04,1.17 19.91,10.05 21.08,21.09 1.61,15.16 -11.1,27.88 -26.26,26.27 -11.04,-1.17 -19.92,-10.05 -21.09,-21.09 -1.5,-14.21 9.58,-26.28 23.46,-26.41 z m 0.04,4.77 c -11.1,0.11 -19.97,9.75 -18.77,21.13 0.95,8.84 8.04,15.94 16.88,16.88 12.13,1.28 22.31,-8.89 21.02,-21.02 -0.94,-8.84 -8.04,-15.94 -16.88,-16.88 -0.76,-0.08 -1.5,-0.11 -2.24,-0.11 z m 0.18,45.8 c 12.01,0 21.74,9.73 21.74,21.73 v 14.42 c 0,1.61 -1.32,2.93 -2.93,2.93 h -37.62 c -1.61,0 -2.92,-1.32 -2.92,-2.93 v -14.42 c 0,-12 9.74,-21.73 21.74,-21.73 z"/>
                    </g>
                </svg>
                <h1 style={{fontSize: 32, marginLeft: 12, color: '#5B6063', display: 'flex'}}>Tonse Jobs</h1>
            </div>

            <div style={{fontSize: 64, fontStyle: 'bold', textAlign: 'center', lineHeight: 1, display: 'flex'}}>{truncate(job.title, 54)}</div>
            <div style={{fontSize: 38, display: 'flex'}}>{truncate(job.company.name, 40)}</div>
            <div style={{fontSize: 32, display: 'flex', marginTop: 8}}>{rawDescription}</div>
            {job.closes_at && <div style={{fontSize: 28, color: '#5B6063', display: 'flex'}}>Application deadline: {new Date(job.closes_at).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric', })}</div>}
            <svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 155 60" width={200} style={{marginTop: 64}}>
                <rect fill="#FFFFFF" width={155} height={60} fillOpacity={0}/>
                <rect x={10} y={10} width={135} height={40} rx={5} ry={5}/>
                <path fill="#a6a6a6"
                      d="M140,10.8c2.316,0,4.2,1.884,4.2,4.2v30c0,2.316-1.884,4.2-4.2,4.2H15c-2.316,0-4.2-1.884-4.2-4.2V15c0-2.316,1.884-4.2,4.2-4.2h125M140,10H15c-2.75,0-5,2.25-5,5v30c0,2.75,2.25,5,5,5h125c2.75,0,5-2.25,5-5V15c0-2.75-2.25-5-5-5h0Z"/>
                <g>
                    <path fill="#FFFFFF" stroke="#fff" strokeMiterlimit={10} strokeWidth=".2px"
                          d="M57.418,20.243c0,.838-.248,1.505-.745,2.003-.564.592-1.3.888-2.204.888-.866,0-1.602-.3-2.208-.9-.606-.601-.909-1.345-.909-2.233s.303-1.633.909-2.233c.605-.601,1.342-.901,2.208-.901.43,0,.841.084,1.232.251.391.168.704.391.938.67l-.527.528c-.397-.475-.944-.712-1.643-.712-.632,0-1.178.222-1.639.666-.461.444-.691,1.021-.691,1.73s.23,1.286.691,1.73c.461.444,1.007.666,1.639.666.67,0,1.229-.223,1.676-.67.29-.291.458-.696.503-1.215h-2.179v-.721h2.907c.028.157.042.307.042.453Z"/>
                    <path fill="#FFFFFF"
                          d="M62.028,17.737h-2.732v1.902h2.464v.721h-2.464v1.902h2.732v.737h-3.503v-6h3.503v.737Z"/>
                    <path fill="#FFFFFF" d="M65.279,23h-.771v-5.263h-1.676v-.737h4.123v.737h-1.676v5.263Z"/>
                    <path fill="#FFFFFF" d="M69.938,23v-6h.77v6h-.77Z"/>
                    <path fill="#FFFFFF" d="M74.128,23h-.771v-5.263h-1.676v-.737h4.123v.737h-1.676v5.263Z"/>
                    <path fill="#FFFFFF"
                          d="M83.609,22.225c-.59.607-1.323.909-2.2.909s-1.61-.303-2.199-.909c-.59-.606-.884-1.348-.884-2.225s.294-1.619.884-2.225c.589-.607,1.322-.91,2.199-.91.872,0,1.603.305,2.196.914.592.609.888,1.349.888,2.221,0,.877-.295,1.619-.884,2.225ZM79.779,21.722c.444.45.987.674,1.63.674s1.186-.225,1.63-.674c.444-.45.667-1.024.667-1.722s-.223-1.273-.667-1.722c-.443-.45-.987-.674-1.63-.674s-1.186.225-1.63.674c-.443.45-.666,1.024-.666,1.722s.223,1.273.666,1.722Z"/>
                    <path fill="#FFFFFF"
                          d="M85.575,23v-6h.939l2.916,4.667h.033l-.033-1.156v-3.511h.771v6h-.805l-3.051-4.894h-.033l.033,1.156v3.737h-.771Z"/>
                </g>
                <path fill="#FFFFFF"
                      d="M78.136,31.752c-2.352,0-4.269,1.788-4.269,4.253,0,2.449,1.917,4.253,4.269,4.253s4.269-1.804,4.269-4.253c0-2.465-1.917-4.253-4.269-4.253ZM78.136,38.582c-1.289,0-2.4-1.063-2.4-2.578,0-1.531,1.112-2.578,2.4-2.578s2.4,1.047,2.4,2.578c0,1.514-1.112,2.578-2.4,2.578ZM68.823,31.752c-2.352,0-4.269,1.788-4.269,4.253,0,2.449,1.917,4.253,4.269,4.253s4.269-1.804,4.269-4.253c0-2.465-1.917-4.253-4.269-4.253ZM68.823,38.582c-1.289,0-2.401-1.063-2.401-2.578,0-1.531,1.112-2.578,2.401-2.578s2.4,1.047,2.4,2.578c0,1.514-1.112,2.578-2.4,2.578ZM57.744,33.057v1.804h4.318c-.129,1.015-.467,1.756-.983,2.272-.628.628-1.611,1.321-3.335,1.321-2.658,0-4.736-2.143-4.736-4.801s2.078-4.801,4.736-4.801c1.434,0,2.481.564,3.254,1.289l1.273-1.273c-1.079-1.031-2.513-1.82-4.527-1.82-3.641,0-6.702,2.964-6.702,6.605s3.061,6.605,6.702,6.605c1.966,0,3.448-.644,4.608-1.853,1.192-1.192,1.563-2.868,1.563-4.221,0-.419-.032-.805-.097-1.128h-6.074ZM103.052,34.458c-.354-.95-1.434-2.707-3.641-2.707-2.191,0-4.011,1.724-4.011,4.253,0,2.384,1.804,4.253,4.221,4.253,1.949,0,3.077-1.192,3.544-1.885l-1.45-.967c-.483.709-1.144,1.176-2.094,1.176s-1.627-.435-2.062-1.289l5.687-2.352-.193-.483ZM97.252,35.876c-.048-1.643,1.273-2.481,2.223-2.481.741,0,1.369.37,1.579.902l-3.802,1.579ZM92.629,40h1.869v-12.502h-1.869v12.502ZM89.567,32.702h-.064c-.419-.499-1.224-.951-2.239-.951-2.127,0-4.076,1.869-4.076,4.269,0,2.384,1.949,4.237,4.076,4.237,1.015,0,1.82-.451,2.239-.967h.064v.612c0,1.627-.87,2.497-2.272,2.497-1.144,0-1.853-.822-2.143-1.514l-1.627.677c.467,1.128,1.708,2.513,3.77,2.513,2.191,0,4.044-1.289,4.044-4.43v-7.636h-1.772v.693ZM87.425,38.582c-1.289,0-2.368-1.079-2.368-2.562,0-1.498,1.079-2.594,2.368-2.594,1.273,0,2.272,1.096,2.272,2.594,0,1.482-.999,2.562-2.272,2.562ZM111.806,27.499h-4.471v12.501h1.866v-4.736h2.605c2.068,0,4.101-1.497,4.101-3.883s-2.033-3.882-4.101-3.882ZM111.854,33.524h-2.654v-4.285h2.654c1.395,0,2.187,1.155,2.187,2.143,0,.969-.792,2.143-2.187,2.143ZM123.386,31.729c-1.351,0-2.75.595-3.329,1.914l1.657.692c.354-.692,1.013-.917,1.705-.917.965,0,1.946.579,1.962,1.608v.129c-.338-.193-1.061-.483-1.946-.483-1.785,0-3.603.981-3.603,2.815,0,1.673,1.463,2.75,3.104,2.75,1.254,0,1.946-.563,2.38-1.222h.064v.965h1.801v-4.793c0-2.22-1.657-3.458-3.796-3.458ZM123.161,38.58c-.611,0-1.464-.305-1.464-1.061,0-.965,1.061-1.335,1.978-1.335.82,0,1.206.177,1.705.418-.145,1.158-1.142,1.978-2.219,1.978ZM133.743,32.002l-2.139,5.42h-.064l-2.219-5.42h-2.01l3.329,7.575-1.898,4.214h1.946l5.131-11.789h-2.075ZM116.936,40h1.866v-12.501h-1.866v12.501Z"/>
                <g>
                    <path fill="#ea4335"
                          d="M30.717,29.424l-10.647,11.3s.001.005.002.007c.327,1.227,1.447,2.13,2.777,2.13.531,0,1.031-.144,1.459-.396l.034-.02,11.984-6.915-5.609-6.106Z"/>
                    <path fill="#fbbc04"
                          d="M41.488,27.5l-.01-.007-5.174-3-5.829,5.187,5.849,5.848,5.146-2.969c.902-.487,1.515-1.438,1.515-2.535,0-1.09-.604-2.036-1.498-2.525Z"/>
                    <path fill="#4285f4"
                          d="M20.07,19.277c-.064.236-.098.484-.098.74v19.968c0,.256.033.504.098.739l11.013-11.011-11.013-10.436Z"/>
                    <path fill="#34a853"
                          d="M30.796,30.001l5.51-5.509-11.97-6.94c-.435-.261-.943-.411-1.486-.411-1.33,0-2.452.905-2.779,2.134,0,0,0,.002,0,.003l10.726,10.724Z"/>
                </g>
            </svg>
        </div>,
        {
            ...size,
        },
    )
}